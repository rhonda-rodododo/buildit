-- Combined module tables migration
-- Generated by tools/codegen from protocol schemas
-- Modules: polls, forms, microblogging, documents, events, mutual-aid, marketplace, crm, tasks, publishing, groups, fundraising, training, social-publishing, newsletters, wiki, search, database, calling, files, contacts, custom-fields, governance

-- Polls module tables
-- Generated from protocol/schemas/modules/polls/v1.json
-- Version: 1.0.0

-- ── polls ──

CREATE TABLE IF NOT EXISTS "polls" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "post_id" TEXT,
    "author_id" TEXT NOT NULL,
    "question" TEXT NOT NULL,
    "options" TEXT NOT NULL,
    "poll_type" TEXT NOT NULL CHECK("poll_type" IN ('single', 'multiple', 'ranked_choice')),
    "status" TEXT CHECK("status" IN ('draft', 'active', 'closed', 'cancelled')),
    "ends_at" INTEGER NOT NULL,
    "is_ended" INTEGER,
    "total_votes" INTEGER NOT NULL,
    "voter_count" INTEGER,
    "hide_results_until_ended" INTEGER,
    "allow_anonymous_votes" INTEGER,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "nostr_event_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_polls_post_id" ON "polls"("post_id");
CREATE INDEX IF NOT EXISTS "idx_polls_author_id" ON "polls"("author_id");
CREATE INDEX IF NOT EXISTS "idx_polls_status" ON "polls"("status");
CREATE INDEX IF NOT EXISTS "idx_polls_ends_at" ON "polls"("ends_at");
CREATE INDEX IF NOT EXISTS "idx_polls_created_at" ON "polls"("created_at");


-- ── poll_votes ──

CREATE TABLE IF NOT EXISTS "poll_votes" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "poll_id" TEXT NOT NULL,
    "option_ids" TEXT NOT NULL,
    "voter_id" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "nostr_event_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_poll_votes_poll_id" ON "poll_votes"("poll_id");
CREATE INDEX IF NOT EXISTS "idx_poll_votes_voter_id" ON "poll_votes"("voter_id");
CREATE INDEX IF NOT EXISTS "idx_poll_votes_poll_id_voter_id" ON "poll_votes"("poll_id", "voter_id");



-- Forms module tables
-- Generated from protocol/schemas/modules/forms/v1.json
-- Version: 1.0.0

-- ── forms ──

CREATE TABLE IF NOT EXISTS "forms" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "fields" TEXT NOT NULL,
    "group_id" TEXT,
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('private', 'group', 'public')),
    "anonymous" INTEGER DEFAULT 0,
    "allow_multiple" INTEGER DEFAULT 0,
    "opens_at" INTEGER,
    "closes_at" INTEGER,
    "max_responses" INTEGER,
    "confirmation_message" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "status" TEXT CHECK("status" IN ('draft', 'open', 'closed', 'archived')),
    "updated_at" INTEGER,
    "table_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_forms_group_id" ON "forms"("group_id");
CREATE INDEX IF NOT EXISTS "idx_forms_status" ON "forms"("status");
CREATE INDEX IF NOT EXISTS "idx_forms_created_at" ON "forms"("created_at");


-- ── form_responses ──

CREATE TABLE IF NOT EXISTS "form_responses" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "form_id" TEXT NOT NULL,
    "answers" TEXT NOT NULL,
    "respondent" TEXT,
    "submitted_at" INTEGER NOT NULL,
    "group_id" TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_form_responses_form_id" ON "form_responses"("form_id");
CREATE INDEX IF NOT EXISTS "idx_form_responses_group_id" ON "form_responses"("group_id");
CREATE INDEX IF NOT EXISTS "idx_form_responses_respondent_pubkey" ON "form_responses"("respondent_pubkey");
CREATE INDEX IF NOT EXISTS "idx_form_responses_submitted_at" ON "form_responses"("submitted_at");



-- Microblogging module tables
-- Generated from protocol/schemas/modules/microblogging/v1.json
-- Version: 1.0.0

-- ── posts ──

CREATE TABLE IF NOT EXISTS "posts" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "author_id" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "content_type" TEXT NOT NULL CHECK("content_type" IN ('text', 'image', 'video', 'poll', 'event-share', 'document-share')),
    "visibility" TEXT NOT NULL,
    "media" TEXT,
    "link_previews" TEXT,
    "location" TEXT,
    "reaction_count" INTEGER DEFAULT 0,
    "comment_count" INTEGER DEFAULT 0,
    "repost_count" INTEGER DEFAULT 0,
    "bookmark_count" INTEGER DEFAULT 0,
    "mentions" TEXT,
    "hashtags" TEXT,
    "links" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "nostr_event_id" TEXT,
    "relay_urls" TEXT,
    "is_repost" INTEGER,
    "reposted_post_id" TEXT,
    "is_quote" INTEGER,
    "quoted_post_id" TEXT,
    "quoted_content" TEXT,
    "content_warning" TEXT,
    "is_sensitive" INTEGER,
    "is_pinned" INTEGER,
    "pinned_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_posts_author_id" ON "posts"("author_id");
CREATE INDEX IF NOT EXISTS "idx_posts_content_type" ON "posts"("content_type");
CREATE INDEX IF NOT EXISTS "idx_posts_created_at" ON "posts"("created_at");
CREATE INDEX IF NOT EXISTS "idx_posts_nostr_event_id" ON "posts"("nostr_event_id");


-- ── comments ──

CREATE TABLE IF NOT EXISTS "comments" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "post_id" TEXT NOT NULL,
    "author_id" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "parent_comment_id" TEXT,
    "depth" INTEGER NOT NULL,
    "reaction_count" INTEGER DEFAULT 0,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "nostr_event_id" TEXT,
    "is_reported" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_comments_post_id" ON "comments"("post_id");
CREATE INDEX IF NOT EXISTS "idx_comments_author_id" ON "comments"("author_id");
CREATE INDEX IF NOT EXISTS "idx_comments_parent_comment_id" ON "comments"("parent_comment_id");
CREATE INDEX IF NOT EXISTS "idx_comments_created_at" ON "comments"("created_at");


-- ── reactions ──

CREATE TABLE IF NOT EXISTS "reactions" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "post_id" TEXT NOT NULL,
    "user_id" TEXT NOT NULL,
    "type" TEXT NOT NULL CHECK("type" IN ('heart', 'fist', 'fire', 'eyes', 'laugh', 'thumbs_up')),
    "created_at" INTEGER NOT NULL,
    "nostr_event_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_reactions_post_id" ON "reactions"("post_id");
CREATE INDEX IF NOT EXISTS "idx_reactions_user_id" ON "reactions"("user_id");
CREATE INDEX IF NOT EXISTS "idx_reactions_post_id_user_id" ON "reactions"("post_id", "user_id");


-- ── reposts ──

CREATE TABLE IF NOT EXISTS "reposts" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "post_id" TEXT NOT NULL,
    "user_id" TEXT NOT NULL,
    "is_quote" INTEGER NOT NULL,
    "quote_content" TEXT,
    "created_at" INTEGER NOT NULL,
    "nostr_event_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_reposts_post_id" ON "reposts"("post_id");
CREATE INDEX IF NOT EXISTS "idx_reposts_user_id" ON "reposts"("user_id");


-- ── bookmarks ──

CREATE TABLE IF NOT EXISTS "bookmarks" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "post_id" TEXT NOT NULL,
    "user_id" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "collection_id" TEXT,
    "tags" TEXT,
    "notes" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_bookmarks_post_id" ON "bookmarks"("post_id");
CREATE INDEX IF NOT EXISTS "idx_bookmarks_user_id" ON "bookmarks"("user_id");
CREATE INDEX IF NOT EXISTS "idx_bookmarks_collection_id" ON "bookmarks"("collection_id");



-- Documents module tables
-- Generated from protocol/schemas/modules/documents/v1.json
-- Version: 1.0.0

-- ── documents ──

CREATE TABLE IF NOT EXISTS "documents" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "title" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "type" TEXT NOT NULL CHECK("type" IN ('markdown', 'plain_text', 'rich_text')),
    "summary" TEXT,
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('private', 'group', 'public')),
    "edit_permission" TEXT DEFAULT 'owner' CHECK("edit_permission" IN ('owner', 'editors', 'group', 'public')),
    "group_id" TEXT,
    "parent_id" TEXT,
    "tags" TEXT,
    "attachments" TEXT,
    "editors" TEXT,
    "link_previews" TEXT,
    "version" INTEGER DEFAULT 1,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "updated_by" TEXT,
    "folder_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_documents_group_id" ON "documents"("group_id");
CREATE INDEX IF NOT EXISTS "idx_documents_type" ON "documents"("type");
CREATE INDEX IF NOT EXISTS "idx_documents_visibility" ON "documents"("visibility");
CREATE INDEX IF NOT EXISTS "idx_documents_created_by" ON "documents"("created_by");
CREATE INDEX IF NOT EXISTS "idx_documents_created_at" ON "documents"("created_at");
CREATE INDEX IF NOT EXISTS "idx_documents_updated_at" ON "documents"("updated_at");
CREATE INDEX IF NOT EXISTS "idx_documents_group_id_updated_at" ON "documents"("group_id", "updated_at");


-- ── document_revisions ──

CREATE TABLE IF NOT EXISTS "document_revisions" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "document_id" TEXT NOT NULL,
    "version" INTEGER NOT NULL,
    "content" TEXT NOT NULL,
    "change_note" TEXT,
    "edited_by" TEXT NOT NULL,
    "edited_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_document_revisions_document_id" ON "document_revisions"("document_id");
CREATE INDEX IF NOT EXISTS "idx_document_revisions_version" ON "document_revisions"("version");
CREATE INDEX IF NOT EXISTS "idx_document_revisions_created_at" ON "document_revisions"("created_at");



-- Events module tables
-- Generated from protocol/schemas/modules/events/v1.json
-- Version: 1.0.0

-- ── events ──

CREATE TABLE IF NOT EXISTS "events" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "start_at" INTEGER NOT NULL,
    "end_at" INTEGER,
    "all_day" INTEGER DEFAULT 0,
    "timezone" TEXT,
    "location" TEXT,
    "virtual_url" TEXT,
    "rsvp_deadline" INTEGER,
    "max_attendees" INTEGER,
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('group', 'public', 'private')),
    "recurrence" TEXT,
    "attachments" TEXT,
    "custom_fields" TEXT,
    "link_previews" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "image_url" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_events_group_id" ON "events"("group_id");
CREATE INDEX IF NOT EXISTS "idx_events_start_at" ON "events"("start_at");
CREATE INDEX IF NOT EXISTS "idx_events_created_by" ON "events"("created_by");
CREATE INDEX IF NOT EXISTS "idx_events_visibility" ON "events"("visibility");
CREATE INDEX IF NOT EXISTS "idx_events_created_at" ON "events"("created_at");


-- ── rsvps ──

CREATE TABLE IF NOT EXISTS "rsvps" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "event_id" TEXT NOT NULL,
    "pubkey" TEXT NOT NULL,
    "status" TEXT NOT NULL CHECK("status" IN ('going', 'maybe', 'not_going')),
    "guest_count" INTEGER DEFAULT 0,
    "note" TEXT,
    "responded_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_rsvps_event_id" ON "rsvps"("event_id");
CREATE INDEX IF NOT EXISTS "idx_rsvps_pubkey" ON "rsvps"("pubkey");
CREATE INDEX IF NOT EXISTS "idx_rsvps_status" ON "rsvps"("status");
CREATE INDEX IF NOT EXISTS "idx_rsvps_event_id_pubkey" ON "rsvps"("event_id", "pubkey");



-- MutualAid module tables
-- Generated from protocol/schemas/modules/mutual-aid/v1.json
-- Version: 1.0.0

-- ── mutual_aid_requests ──

CREATE TABLE IF NOT EXISTS "mutual_aid_requests" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "category" TEXT NOT NULL,
    "status" TEXT NOT NULL CHECK("status" IN ('open', 'in-progress', 'partially-fulfilled', 'fulfilled', 'closed', 'expired', 'cancelled')),
    "urgency" TEXT CHECK("urgency" IN ('low', 'medium', 'high', 'critical')),
    "requester_id" TEXT NOT NULL,
    "anonymous_request" INTEGER DEFAULT 0,
    "location" TEXT,
    "needed_by" INTEGER,
    "recurring_need" TEXT,
    "fulfillments" TEXT,
    "quantity_needed" REAL,
    "quantity_fulfilled" REAL DEFAULT 0,
    "unit" TEXT,
    "tags" TEXT,
    "custom_fields" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "closed_at" INTEGER,
    "image_url" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_mutual_aid_requests_group_id" ON "mutual_aid_requests"("group_id");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_requests_category" ON "mutual_aid_requests"("category");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_requests_status" ON "mutual_aid_requests"("status");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_requests_urgency" ON "mutual_aid_requests"("urgency");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_requests_requester_id" ON "mutual_aid_requests"("requester_id");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_requests_created_at" ON "mutual_aid_requests"("created_at");


-- ── mutual_aid_offers ──

CREATE TABLE IF NOT EXISTS "mutual_aid_offers" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "category" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'active' CHECK("status" IN ('active', 'claimed', 'expired', 'withdrawn')),
    "offerer_id" TEXT NOT NULL,
    "location" TEXT,
    "available_from" INTEGER,
    "available_until" INTEGER,
    "recurring_availability" TEXT,
    "quantity" REAL,
    "unit" TEXT,
    "claimed_by" TEXT,
    "tags" TEXT,
    "custom_fields" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "image_url" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_mutual_aid_offers_group_id" ON "mutual_aid_offers"("group_id");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_offers_category" ON "mutual_aid_offers"("category");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_offers_status" ON "mutual_aid_offers"("status");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_offers_offerer_id" ON "mutual_aid_offers"("offerer_id");
CREATE INDEX IF NOT EXISTS "idx_mutual_aid_offers_created_at" ON "mutual_aid_offers"("created_at");


-- ── ride_shares ──

CREATE TABLE IF NOT EXISTS "ride_shares" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "type" TEXT NOT NULL CHECK("type" IN ('offer', 'request')),
    "driver_id" TEXT,
    "requester_id" TEXT,
    "origin" TEXT NOT NULL,
    "destination" TEXT NOT NULL,
    "departure_time" INTEGER NOT NULL,
    "flexibility" INTEGER,
    "available_seats" INTEGER,
    "recurring" TEXT,
    "preferences" TEXT,
    "passengers" TEXT,
    "status" TEXT NOT NULL CHECK("status" IN ('active', 'full', 'departed', 'completed', 'cancelled')),
    "notes" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_ride_shares_group_id" ON "ride_shares"("group_id");
CREATE INDEX IF NOT EXISTS "idx_ride_shares_type" ON "ride_shares"("type");
CREATE INDEX IF NOT EXISTS "idx_ride_shares_status" ON "ride_shares"("status");
CREATE INDEX IF NOT EXISTS "idx_ride_shares_departure_time" ON "ride_shares"("departure_time");
CREATE INDEX IF NOT EXISTS "idx_ride_shares_created_at" ON "ride_shares"("created_at");


-- ── resource_directory ──

CREATE TABLE IF NOT EXISTS "resource_directory" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "category" TEXT NOT NULL,
    "contact" TEXT,
    "location" TEXT,
    "hours" TEXT,
    "eligibility" TEXT,
    "languages" TEXT,
    "verified" INTEGER DEFAULT 0,
    "verified_by" TEXT,
    "verified_at" INTEGER,
    "tags" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_resource_directory_group_id" ON "resource_directory"("group_id");
CREATE INDEX IF NOT EXISTS "idx_resource_directory_category" ON "resource_directory"("category");
CREATE INDEX IF NOT EXISTS "idx_resource_directory_verified" ON "resource_directory"("verified");
CREATE INDEX IF NOT EXISTS "idx_resource_directory_created_by" ON "resource_directory"("created_by");
CREATE INDEX IF NOT EXISTS "idx_resource_directory_created_at" ON "resource_directory"("created_at");



-- Marketplace module tables
-- Generated from protocol/schemas/modules/marketplace/v1.json
-- Version: 1.0.0

-- ── listings ──

CREATE TABLE IF NOT EXISTS "listings" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "type" TEXT NOT NULL CHECK("type" IN ('product', 'service', 'co-op', 'initiative', 'resource')),
    "title" TEXT NOT NULL,
    "description" TEXT,
    "price" REAL,
    "currency" TEXT,
    "images" TEXT,
    "location" TEXT,
    "availability" TEXT,
    "tags" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "expires_at" INTEGER,
    "status" TEXT NOT NULL DEFAULT 'active' CHECK("status" IN ('active', 'sold', 'expired', 'removed')),
    "group_id" TEXT,
    "coop_id" TEXT,
    "contact_method" TEXT DEFAULT 'dm' CHECK("contact_method" IN ('dm', 'public-reply'))
);

CREATE INDEX IF NOT EXISTS "idx_listings_group_id" ON "listings"("group_id");
CREATE INDEX IF NOT EXISTS "idx_listings_type" ON "listings"("type");
CREATE INDEX IF NOT EXISTS "idx_listings_status" ON "listings"("status");
CREATE INDEX IF NOT EXISTS "idx_listings_created_by" ON "listings"("created_by");
CREATE INDEX IF NOT EXISTS "idx_listings_created_at" ON "listings"("created_at");
CREATE INDEX IF NOT EXISTS "idx_listings_expires_at" ON "listings"("expires_at");


-- ── coop_profiles ──

CREATE TABLE IF NOT EXISTS "coop_profiles" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "member_count" INTEGER,
    "governance_model" TEXT CHECK("governance_model" IN ('consensus', 'democratic', 'sociocracy', 'holacracy', 'hybrid', 'other')),
    "industry" TEXT,
    "location" TEXT,
    "website" TEXT,
    "nostr_pubkey" TEXT NOT NULL,
    "verified_by" TEXT,
    "image" TEXT,
    "created_at" INTEGER,
    "updated_at" INTEGER,
    "group_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_coop_profiles_group_id" ON "coop_profiles"("group_id");
CREATE INDEX IF NOT EXISTS "idx_coop_profiles_nostr_pubkey" ON "coop_profiles"("nostr_pubkey");
CREATE INDEX IF NOT EXISTS "idx_coop_profiles_industry" ON "coop_profiles"("industry");
CREATE INDEX IF NOT EXISTS "idx_coop_profiles_governance_model" ON "coop_profiles"("governance_model");


-- ── reviews ──

CREATE TABLE IF NOT EXISTS "reviews" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "listing_id" TEXT NOT NULL,
    "reviewer_pubkey" TEXT NOT NULL,
    "rating" INTEGER NOT NULL,
    "text" TEXT,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_reviews_listing_id" ON "reviews"("listing_id");
CREATE INDEX IF NOT EXISTS "idx_reviews_reviewer_pubkey" ON "reviews"("reviewer_pubkey");
CREATE INDEX IF NOT EXISTS "idx_reviews_rating" ON "reviews"("rating");
CREATE INDEX IF NOT EXISTS "idx_reviews_created_at" ON "reviews"("created_at");


-- ── skill_exchanges ──

CREATE TABLE IF NOT EXISTS "skill_exchanges" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "offered_skill" TEXT NOT NULL,
    "requested_skill" TEXT NOT NULL,
    "available_hours" REAL,
    "hourly_timebank" REAL,
    "location" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "status" TEXT DEFAULT 'active' CHECK("status" IN ('active', 'matched', 'completed', 'cancelled')),
    "group_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_skill_exchanges_group_id" ON "skill_exchanges"("group_id");
CREATE INDEX IF NOT EXISTS "idx_skill_exchanges_status" ON "skill_exchanges"("status");
CREATE INDEX IF NOT EXISTS "idx_skill_exchanges_created_by" ON "skill_exchanges"("created_by");
CREATE INDEX IF NOT EXISTS "idx_skill_exchanges_created_at" ON "skill_exchanges"("created_at");


-- ── resource_shares ──

CREATE TABLE IF NOT EXISTS "resource_shares" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "resource_type" TEXT NOT NULL CHECK("resource_type" IN ('tool', 'space', 'vehicle')),
    "name" TEXT NOT NULL,
    "description" TEXT,
    "availability" TEXT,
    "location" TEXT,
    "deposit_required" INTEGER DEFAULT 0,
    "deposit_amount" REAL,
    "deposit_currency" TEXT,
    "images" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "status" TEXT DEFAULT 'available' CHECK("status" IN ('available', 'borrowed', 'unavailable')),
    "group_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_resource_shares_group_id" ON "resource_shares"("group_id");
CREATE INDEX IF NOT EXISTS "idx_resource_shares_resource_type" ON "resource_shares"("resource_type");
CREATE INDEX IF NOT EXISTS "idx_resource_shares_status" ON "resource_shares"("status");
CREATE INDEX IF NOT EXISTS "idx_resource_shares_created_by" ON "resource_shares"("created_by");



-- Crm module tables
-- Generated from protocol/schemas/modules/crm/v1.json
-- Version: 1.0.0

-- ── contacts ──

CREATE TABLE IF NOT EXISTS "contacts" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "pubkey" TEXT,
    "name" TEXT,
    "email" TEXT,
    "phone" TEXT,
    "address" TEXT,
    "organization" TEXT,
    "title" TEXT,
    "tags" TEXT,
    "source" TEXT,
    "notes" TEXT,
    "custom_fields" TEXT,
    "group_id" TEXT,
    "status" TEXT DEFAULT 'active' CHECK("status" IN ('active', 'inactive', 'archived')),
    "last_contacted_at" INTEGER,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_contacts_group_id" ON "contacts"("group_id");
CREATE INDEX IF NOT EXISTS "idx_contacts_name" ON "contacts"("name");
CREATE INDEX IF NOT EXISTS "idx_contacts_email" ON "contacts"("email");
CREATE INDEX IF NOT EXISTS "idx_contacts_status" ON "contacts"("status");
CREATE INDEX IF NOT EXISTS "idx_contacts_created_at" ON "contacts"("created_at");
CREATE INDEX IF NOT EXISTS "idx_contacts_updated_at" ON "contacts"("updated_at");


-- ── interactions ──

CREATE TABLE IF NOT EXISTS "interactions" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "contact_id" TEXT NOT NULL,
    "type" TEXT NOT NULL CHECK("type" IN ('call', 'email', 'meeting', 'text', 'event', 'note', 'other')),
    "summary" TEXT,
    "notes" TEXT,
    "outcome" TEXT,
    "follow_up_date" INTEGER,
    "occurred_at" INTEGER NOT NULL,
    "logged_by" TEXT NOT NULL,
    "group_id" TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_interactions_contact_id" ON "interactions"("contact_id");
CREATE INDEX IF NOT EXISTS "idx_interactions_group_id" ON "interactions"("group_id");
CREATE INDEX IF NOT EXISTS "idx_interactions_type" ON "interactions"("type");
CREATE INDEX IF NOT EXISTS "idx_interactions_date" ON "interactions"("date");
CREATE INDEX IF NOT EXISTS "idx_interactions_follow_up_date" ON "interactions"("follow_up_date");


-- ── crm_tasks ──

CREATE TABLE IF NOT EXISTS "crm_tasks" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "contact_id" TEXT,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "due_at" INTEGER,
    "priority" TEXT DEFAULT 'medium' CHECK("priority" IN ('low', 'medium', 'high', 'urgent')),
    "status" TEXT DEFAULT 'pending' CHECK("status" IN ('pending', 'in_progress', 'completed', 'cancelled')),
    "assigned_to" TEXT,
    "completed_at" INTEGER,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "group_id" TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_crm_tasks_contact_id" ON "crm_tasks"("contact_id");
CREATE INDEX IF NOT EXISTS "idx_crm_tasks_group_id" ON "crm_tasks"("group_id");
CREATE INDEX IF NOT EXISTS "idx_crm_tasks_status" ON "crm_tasks"("status");
CREATE INDEX IF NOT EXISTS "idx_crm_tasks_priority" ON "crm_tasks"("priority");
CREATE INDEX IF NOT EXISTS "idx_crm_tasks_due_date" ON "crm_tasks"("due_date");
CREATE INDEX IF NOT EXISTS "idx_crm_tasks_assigned_to" ON "crm_tasks"("assigned_to");



-- Tasks module tables
-- Generated from protocol/schemas/modules/tasks/v1.json
-- Version: 1.0.0

-- ── tasks ──

CREATE TABLE IF NOT EXISTS "tasks" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "status" TEXT CHECK("status" IN ('todo', 'in_progress', 'done', 'cancelled')),
    "priority" TEXT CHECK("priority" IN ('low', 'medium', 'high', 'urgent')),
    "assignee_pubkey" TEXT,
    "created_by" TEXT NOT NULL,
    "due_date" INTEGER,
    "completed_at" INTEGER,
    "tags" TEXT,
    "checklist" TEXT,
    "parent_task_id" TEXT,
    "sort_order" INTEGER DEFAULT 0,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_tasks_group_id" ON "tasks"("group_id");
CREATE INDEX IF NOT EXISTS "idx_tasks_assignee_pubkey" ON "tasks"("assignee_pubkey");
CREATE INDEX IF NOT EXISTS "idx_tasks_status" ON "tasks"("status");
CREATE INDEX IF NOT EXISTS "idx_tasks_due_date" ON "tasks"("due_date");
CREATE INDEX IF NOT EXISTS "idx_tasks_created_by" ON "tasks"("created_by");



-- Publishing module tables
-- Generated from protocol/schemas/modules/publishing/v1.json
-- Version: 1.0.0

-- ── articles ──

CREATE TABLE IF NOT EXISTS "articles" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "title" TEXT NOT NULL,
    "slug" TEXT,
    "subtitle" TEXT,
    "content" TEXT NOT NULL,
    "excerpt" TEXT,
    "cover_image" TEXT,
    "tags" TEXT,
    "categories" TEXT,
    "status" TEXT DEFAULT 'draft' CHECK("status" IN ('draft', 'published', 'archived')),
    "visibility" TEXT DEFAULT 'public' CHECK("visibility" IN ('private', 'group', 'public')),
    "group_id" TEXT,
    "published_at" INTEGER,
    "author_pubkey" TEXT NOT NULL,
    "author_name" TEXT,
    "coauthors" TEXT,
    "reading_time" INTEGER,
    "view_count" INTEGER DEFAULT 0,
    "canonical_url" TEXT,
    "seo" TEXT,
    "link_previews" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_articles_publication_id" ON "articles"("publication_id");
CREATE INDEX IF NOT EXISTS "idx_articles_group_id" ON "articles"("group_id");
CREATE INDEX IF NOT EXISTS "idx_articles_slug" ON "articles"("slug");
CREATE INDEX IF NOT EXISTS "idx_articles_status" ON "articles"("status");
CREATE INDEX IF NOT EXISTS "idx_articles_visibility" ON "articles"("visibility");
CREATE INDEX IF NOT EXISTS "idx_articles_author_pubkey" ON "articles"("author_pubkey");
CREATE INDEX IF NOT EXISTS "idx_articles_published_at" ON "articles"("published_at");
CREATE INDEX IF NOT EXISTS "idx_articles_created_at" ON "articles"("created_at");
CREATE INDEX IF NOT EXISTS "idx_articles_updated_at" ON "articles"("updated_at");
CREATE INDEX IF NOT EXISTS "idx_articles_publication_id_status" ON "articles"("publication_id", "status");
CREATE INDEX IF NOT EXISTS "idx_articles_publication_id_published_at" ON "articles"("publication_id", "published_at");


-- ── article_comments ──

CREATE TABLE IF NOT EXISTS "article_comments" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "article_id" TEXT NOT NULL,
    "parent_id" TEXT,
    "content" TEXT NOT NULL,
    "author_pubkey" TEXT NOT NULL,
    "author_name" TEXT,
    "link_previews" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_article_comments_article_id" ON "article_comments"("article_id");
CREATE INDEX IF NOT EXISTS "idx_article_comments_author_pubkey" ON "article_comments"("author_pubkey");
CREATE INDEX IF NOT EXISTS "idx_article_comments_parent_id" ON "article_comments"("parent_id");
CREATE INDEX IF NOT EXISTS "idx_article_comments_created_at" ON "article_comments"("created_at");


-- ── publications ──

CREATE TABLE IF NOT EXISTS "publications" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "logo" TEXT,
    "cover_image" TEXT,
    "group_id" TEXT,
    "visibility" TEXT DEFAULT 'public' CHECK("visibility" IN ('private', 'group', 'public')),
    "editors" TEXT,
    "owner_pubkey" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_publications_group_id" ON "publications"("group_id");
CREATE INDEX IF NOT EXISTS "idx_publications_slug" ON "publications"("slug");
CREATE INDEX IF NOT EXISTS "idx_publications_owner_pubkey" ON "publications"("owner_pubkey");
CREATE INDEX IF NOT EXISTS "idx_publications_created_at" ON "publications"("created_at");



-- Groups module tables
-- Generated from protocol/schemas/modules/groups/v1.json
-- Version: 1.0.0

-- ── groups ──

CREATE TABLE IF NOT EXISTS "groups" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "picture" TEXT,
    "privacy_level" TEXT NOT NULL CHECK("privacy_level" IN ('public', 'private', 'secret')),
    "members" TEXT NOT NULL,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "tags" TEXT,
    "website" TEXT,
    "location" TEXT,
    "enabled_modules" TEXT NOT NULL,
    "creation_event_id" TEXT NOT NULL,
    "metadata_event_id" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_groups_created_by" ON "groups"("created_by");
CREATE INDEX IF NOT EXISTS "idx_groups_privacy_level" ON "groups"("privacy_level");
CREATE INDEX IF NOT EXISTS "idx_groups_created_at" ON "groups"("created_at");


-- ── group_members ──

CREATE TABLE IF NOT EXISTS "group_members" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "pubkey" TEXT NOT NULL,
    "role" TEXT NOT NULL CHECK("role" IN ('owner', 'admin', 'moderator', 'member')),
    "joined_at" INTEGER NOT NULL,
    "invited_by" TEXT,
    "permissions" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_group_members_pubkey" ON "group_members"("pubkey");
CREATE INDEX IF NOT EXISTS "idx_group_members_role" ON "group_members"("role");


-- ── group_invitations ──

CREATE TABLE IF NOT EXISTS "group_invitations" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "invited_pubkey" TEXT NOT NULL,
    "invited_by" TEXT NOT NULL,
    "message" TEXT,
    "created_at" INTEGER NOT NULL,
    "expires_at" INTEGER,
    "status" TEXT NOT NULL CHECK("status" IN ('pending', 'accepted', 'declined', 'expired'))
);

CREATE INDEX IF NOT EXISTS "idx_group_invitations_group_id" ON "group_invitations"("group_id");
CREATE INDEX IF NOT EXISTS "idx_group_invitations_invited_pubkey" ON "group_invitations"("invited_pubkey");
CREATE INDEX IF NOT EXISTS "idx_group_invitations_status" ON "group_invitations"("status");


-- ── group_threads ──

CREATE TABLE IF NOT EXISTS "group_threads" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "last_message_at" INTEGER NOT NULL,
    "message_count" INTEGER NOT NULL,
    "category" TEXT,
    "pinned" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_group_threads_group_id" ON "group_threads"("group_id");
CREATE INDEX IF NOT EXISTS "idx_group_threads_created_by" ON "group_threads"("created_by");
CREATE INDEX IF NOT EXISTS "idx_group_threads_last_message_at" ON "group_threads"("last_message_at");


-- ── group_messages ──

CREATE TABLE IF NOT EXISTS "group_messages" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "thread_id" TEXT NOT NULL,
    "group_id" TEXT NOT NULL,
    "from" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "timestamp" INTEGER NOT NULL,
    "reply_to" TEXT,
    "reactions" TEXT,
    "edited" INTEGER,
    "edited_at" INTEGER,
    "deleted" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_group_messages_thread_id" ON "group_messages"("thread_id");
CREATE INDEX IF NOT EXISTS "idx_group_messages_group_id" ON "group_messages"("group_id");
CREATE INDEX IF NOT EXISTS "idx_group_messages_from" ON "group_messages"("from");
CREATE INDEX IF NOT EXISTS "idx_group_messages_timestamp" ON "group_messages"("timestamp");



-- Fundraising module tables
-- Generated from protocol/schemas/modules/fundraising/v1.json
-- Version: 1.0.0

-- ── campaigns ──

CREATE TABLE IF NOT EXISTS "campaigns" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "goal" REAL NOT NULL,
    "currency" TEXT NOT NULL,
    "raised" REAL DEFAULT 0,
    "donor_count" INTEGER DEFAULT 0,
    "starts_at" INTEGER,
    "ends_at" INTEGER,
    "status" TEXT DEFAULT 'draft' CHECK("status" IN ('draft', 'active', 'paused', 'completed', 'cancelled')),
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('private', 'group', 'public')),
    "group_id" TEXT,
    "image" TEXT,
    "tiers" TEXT,
    "updates" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "table_id" TEXT,
    "slug" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_campaigns_group_id" ON "campaigns"("group_id");
CREATE INDEX IF NOT EXISTS "idx_campaigns_status" ON "campaigns"("status");
CREATE INDEX IF NOT EXISTS "idx_campaigns_created_at" ON "campaigns"("created_at");
CREATE INDEX IF NOT EXISTS "idx_campaigns_end_date" ON "campaigns"("end_date");


-- ── donations ──

CREATE TABLE IF NOT EXISTS "donations" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "campaign_id" TEXT NOT NULL,
    "amount" REAL NOT NULL,
    "currency" TEXT NOT NULL,
    "donor_pubkey" TEXT,
    "donor_name" TEXT,
    "anonymous" INTEGER DEFAULT 0,
    "message" TEXT,
    "tier_id" TEXT,
    "payment_method" TEXT CHECK("payment_method" IN ('card', 'bank', 'crypto', 'cash', 'check', 'other')),
    "status" TEXT DEFAULT 'completed' CHECK("status" IN ('pending', 'completed', 'failed', 'refunded')),
    "donated_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_donations_campaign_id" ON "donations"("campaign_id");
CREATE INDEX IF NOT EXISTS "idx_donations_group_id" ON "donations"("group_id");
CREATE INDEX IF NOT EXISTS "idx_donations_status" ON "donations"("status");
CREATE INDEX IF NOT EXISTS "idx_donations_donor_pubkey" ON "donations"("donor_pubkey");
CREATE INDEX IF NOT EXISTS "idx_donations_created_at" ON "donations"("created_at");


-- ── expenses ──

CREATE TABLE IF NOT EXISTS "expenses" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "campaign_id" TEXT NOT NULL,
    "amount" REAL NOT NULL,
    "currency" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "category" TEXT,
    "receipt" TEXT,
    "vendor" TEXT,
    "date" INTEGER,
    "recorded_by" TEXT NOT NULL,
    "recorded_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_expenses_campaign_id" ON "expenses"("campaign_id");
CREATE INDEX IF NOT EXISTS "idx_expenses_category" ON "expenses"("category");
CREATE INDEX IF NOT EXISTS "idx_expenses_date" ON "expenses"("date");



-- Training module tables
-- Generated from protocol/schemas/modules/training/v1.json
-- Version: 1.0.0

-- ── courses ──

CREATE TABLE IF NOT EXISTS "courses" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT,
    "title" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "image_url" TEXT,
    "category" TEXT NOT NULL CHECK("category" IN ('app-basics', 'opsec', 'digital-security', 'legal', 'medic', 'self-defense', 'organizing', 'communication', 'civil-defense', 'custom')),
    "difficulty" TEXT NOT NULL CHECK("difficulty" IN ('beginner', 'intermediate', 'advanced')),
    "estimated_hours" REAL NOT NULL,
    "prerequisites" TEXT,
    "status" TEXT NOT NULL CHECK("status" IN ('draft', 'published', 'archived')),
    "certification_enabled" INTEGER DEFAULT 0,
    "certification_expiry_days" INTEGER,
    "is_public" INTEGER DEFAULT 0,
    "is_default" INTEGER DEFAULT 0,
    "created" INTEGER NOT NULL,
    "created_by" TEXT NOT NULL,
    "updated" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_courses_group_id" ON "courses"("group_id");
CREATE INDEX IF NOT EXISTS "idx_courses_category" ON "courses"("category");
CREATE INDEX IF NOT EXISTS "idx_courses_difficulty" ON "courses"("difficulty");
CREATE INDEX IF NOT EXISTS "idx_courses_status" ON "courses"("status");
CREATE INDEX IF NOT EXISTS "idx_courses_created_by" ON "courses"("created_by");
CREATE INDEX IF NOT EXISTS "idx_courses_created" ON "courses"("created");


-- ── training_modules ──

CREATE TABLE IF NOT EXISTS "training_modules" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "course_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "order" INTEGER NOT NULL,
    "estimated_minutes" INTEGER NOT NULL,
    "created" INTEGER NOT NULL,
    "updated" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_training_modules_course_id" ON "training_modules"("course_id");
CREATE INDEX IF NOT EXISTS "idx_training_modules_order" ON "training_modules"("order");


-- ── lessons ──

CREATE TABLE IF NOT EXISTS "lessons" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "module_id" TEXT NOT NULL,
    "type" TEXT NOT NULL CHECK("type" IN ('video', 'document', 'quiz', 'assignment', 'live-session', 'interactive')),
    "title" TEXT NOT NULL,
    "description" TEXT,
    "order" INTEGER NOT NULL,
    "estimated_minutes" INTEGER NOT NULL,
    "required_for_certification" INTEGER DEFAULT 0,
    "passing_score" INTEGER,
    "created" INTEGER NOT NULL,
    "updated" INTEGER NOT NULL,
    "video_url" TEXT,
    "transcript_url" TEXT,
    "captions_url" TEXT,
    "duration" INTEGER,
    "markdown" TEXT,
    "pdf_url" TEXT,
    "questions" TEXT,
    "allow_retakes" INTEGER,
    "max_attempts" INTEGER,
    "shuffle_questions" INTEGER,
    "shuffle_options" INTEGER,
    "show_correct_after" INTEGER,
    "time_limit_minutes" INTEGER,
    "instructions" TEXT,
    "allowed_file_types" TEXT,
    "max_file_size_m_b" INTEGER,
    "rubric" TEXT,
    "scheduled_at" INTEGER,
    "instructor_pubkey" TEXT,
    "conference_room_id" TEXT,
    "recording_url" TEXT,
    "max_participants" INTEGER,
    "requires_r_s_v_p" INTEGER,
    "exercise_type" TEXT CHECK("exercise_type" IN ('threat-model', 'security-audit', 'scenario', 'simulation', 'custom')),
    "config_json" TEXT,
    "external_url" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_lessons_module_id" ON "lessons"("module_id");
CREATE INDEX IF NOT EXISTS "idx_lessons_type" ON "lessons"("type");
CREATE INDEX IF NOT EXISTS "idx_lessons_order" ON "lessons"("order");


-- ── course_progress ──

CREATE TABLE IF NOT EXISTS "course_progress" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "course_id" TEXT NOT NULL,
    "pubkey" TEXT NOT NULL,
    "percent_complete" REAL NOT NULL,
    "lessons_completed" INTEGER NOT NULL,
    "total_lessons" INTEGER NOT NULL,
    "current_module_id" TEXT,
    "current_lesson_id" TEXT,
    "started_at" INTEGER NOT NULL,
    "last_activity_at" INTEGER NOT NULL,
    "completed_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_course_progress_course_id" ON "course_progress"("course_id");
CREATE INDEX IF NOT EXISTS "idx_course_progress_pubkey" ON "course_progress"("pubkey");
CREATE INDEX IF NOT EXISTS "idx_course_progress_course_id_pubkey" ON "course_progress"("course_id", "pubkey");


-- ── certifications ──

CREATE TABLE IF NOT EXISTS "certifications" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "course_id" TEXT NOT NULL,
    "pubkey" TEXT NOT NULL,
    "earned_at" INTEGER NOT NULL,
    "expires_at" INTEGER,
    "verification_code" TEXT NOT NULL,
    "metadata" TEXT,
    "revoked_at" INTEGER,
    "revoked_by" TEXT,
    "revoke_reason" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_certifications_course_id" ON "certifications"("course_id");
CREATE INDEX IF NOT EXISTS "idx_certifications_pubkey" ON "certifications"("pubkey");
CREATE INDEX IF NOT EXISTS "idx_certifications_verification_code" ON "certifications"("verification_code");



-- SocialPublishing module tables
-- Generated from protocol/schemas/modules/social-publishing/v1.json
-- Version: 1.0.0

-- ── scheduled_content ──

CREATE TABLE IF NOT EXISTS "scheduled_content" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "source_module" TEXT NOT NULL,
    "source_content_id" TEXT NOT NULL,
    "scheduled_at" INTEGER NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'pending' CHECK("status" IN ('pending', 'publishing', 'published', 'failed', 'cancelled')),
    "recurrence" TEXT,
    "cross_post_config" TEXT,
    "signed_event" TEXT,
    "published_at" INTEGER,
    "error_message" TEXT,
    "retry_count" INTEGER DEFAULT 0,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_scheduled_content_source_module" ON "scheduled_content"("source_module");
CREATE INDEX IF NOT EXISTS "idx_scheduled_content_scheduled_at" ON "scheduled_content"("scheduled_at");
CREATE INDEX IF NOT EXISTS "idx_scheduled_content_status" ON "scheduled_content"("status");
CREATE INDEX IF NOT EXISTS "idx_scheduled_content_created_by" ON "scheduled_content"("created_by");
CREATE INDEX IF NOT EXISTS "idx_scheduled_content_created_at" ON "scheduled_content"("created_at");


-- ── share_links ──

CREATE TABLE IF NOT EXISTS "share_links" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "slug" TEXT NOT NULL,
    "source_module" TEXT NOT NULL,
    "source_content_id" TEXT NOT NULL,
    "target_url" TEXT,
    "expires_at" INTEGER,
    "password_hash" TEXT,
    "track_clicks" INTEGER DEFAULT 1,
    "click_count" INTEGER DEFAULT 0,
    "seo_overrides" TEXT,
    "is_active" INTEGER DEFAULT 1,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_share_links_slug" ON "share_links"("slug");
CREATE INDEX IF NOT EXISTS "idx_share_links_source_module" ON "share_links"("source_module");
CREATE INDEX IF NOT EXISTS "idx_share_links_source_content_id" ON "share_links"("source_content_id");
CREATE INDEX IF NOT EXISTS "idx_share_links_created_by" ON "share_links"("created_by");
CREATE INDEX IF NOT EXISTS "idx_share_links_is_active" ON "share_links"("is_active");


-- ── social_accounts ──

CREATE TABLE IF NOT EXISTS "social_accounts" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "platform" TEXT NOT NULL CHECK("platform" IN ('activitypub', 'atproto')),
    "handle" TEXT NOT NULL,
    "display_name" TEXT,
    "avatar_url" TEXT,
    "pubkey" TEXT NOT NULL,
    "is_active" INTEGER DEFAULT 1,
    "last_sync_at" INTEGER,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_social_accounts_platform" ON "social_accounts"("platform");
CREATE INDEX IF NOT EXISTS "idx_social_accounts_pubkey" ON "social_accounts"("pubkey");
CREATE INDEX IF NOT EXISTS "idx_social_accounts_is_active" ON "social_accounts"("is_active");


-- ── content_calendar_entries ──

CREATE TABLE IF NOT EXISTS "content_calendar_entries" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "source_module" TEXT NOT NULL,
    "source_content_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "scheduled_at" INTEGER NOT NULL,
    "status" TEXT NOT NULL CHECK("status" IN ('pending', 'publishing', 'published', 'failed', 'cancelled')),
    "platforms" TEXT,
    "content_type" TEXT CHECK("content_type" IN ('article', 'post', 'event', 'newsletter', 'listing'))
);

CREATE INDEX IF NOT EXISTS "idx_content_calendar_entries_source_module" ON "content_calendar_entries"("source_module");
CREATE INDEX IF NOT EXISTS "idx_content_calendar_entries_scheduled_at" ON "content_calendar_entries"("scheduled_at");
CREATE INDEX IF NOT EXISTS "idx_content_calendar_entries_status" ON "content_calendar_entries"("status");


-- ── outreach_analytics ──

CREATE TABLE IF NOT EXISTS "outreach_analytics" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "share_link_id" TEXT NOT NULL,
    "session_id" TEXT NOT NULL,
    "timestamp" INTEGER NOT NULL,
    "referrer" TEXT,
    "platform" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_outreach_analytics_share_link_id" ON "outreach_analytics"("share_link_id");
CREATE INDEX IF NOT EXISTS "idx_outreach_analytics_timestamp" ON "outreach_analytics"("timestamp");



-- Newsletters module tables
-- Generated from protocol/schemas/modules/newsletters/v1.json
-- Version: 1.0.0

-- ── newsletters ──

CREATE TABLE IF NOT EXISTS "newsletters" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "group_id" TEXT,
    "from_name" TEXT,
    "reply_to" TEXT,
    "logo" TEXT,
    "subscriber_count" INTEGER DEFAULT 0,
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('private', 'group', 'public')),
    "double_opt_in" INTEGER DEFAULT 1,
    "owner_pubkey" TEXT NOT NULL,
    "editors" TEXT,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_newsletters_group_id" ON "newsletters"("group_id");
CREATE INDEX IF NOT EXISTS "idx_newsletters_owner_pubkey" ON "newsletters"("owner_pubkey");
CREATE INDEX IF NOT EXISTS "idx_newsletters_created_at" ON "newsletters"("created_at");
CREATE INDEX IF NOT EXISTS "idx_newsletters_group_id_created_at" ON "newsletters"("group_id", "created_at");


-- ── newsletter_campaigns ──

CREATE TABLE IF NOT EXISTS "newsletter_campaigns" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "newsletter_id" TEXT NOT NULL,
    "subject" TEXT NOT NULL,
    "preheader" TEXT,
    "content" TEXT NOT NULL,
    "content_type" TEXT DEFAULT 'markdown' CHECK("content_type" IN ('html', 'markdown')),
    "status" TEXT DEFAULT 'draft' CHECK("status" IN ('draft', 'scheduled', 'sending', 'sent', 'failed')),
    "scheduled_at" INTEGER,
    "sent_at" INTEGER,
    "recipient_count" INTEGER,
    "open_count" INTEGER DEFAULT 0,
    "click_count" INTEGER DEFAULT 0,
    "segments" TEXT,
    "link_previews" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_newsletter_id" ON "newsletter_campaigns"("newsletter_id");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_group_id" ON "newsletter_campaigns"("group_id");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_status" ON "newsletter_campaigns"("status");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_scheduled_at" ON "newsletter_campaigns"("scheduled_at");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_sent_at" ON "newsletter_campaigns"("sent_at");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_newsletter_id_status" ON "newsletter_campaigns"("newsletter_id", "status");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_newsletter_id_created_at" ON "newsletter_campaigns"("newsletter_id", "created_at");
CREATE INDEX IF NOT EXISTS "idx_newsletter_campaigns_status_scheduled_at" ON "newsletter_campaigns"("status", "scheduled_at");


-- ── newsletter_subscribers ──

CREATE TABLE IF NOT EXISTS "newsletter_subscribers" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "newsletter_id" TEXT NOT NULL,
    "pubkey" TEXT,
    "email" TEXT NOT NULL,
    "name" TEXT,
    "status" TEXT NOT NULL DEFAULT 'pending' CHECK("status" IN ('pending', 'active', 'unsubscribed', 'bounced', 'complained')),
    "segments" TEXT,
    "custom_fields" TEXT,
    "source" TEXT,
    "subscribed_at" INTEGER NOT NULL,
    "confirmed_at" INTEGER,
    "unsubscribed_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_newsletter_subscribers_newsletter_id" ON "newsletter_subscribers"("newsletter_id");
CREATE INDEX IF NOT EXISTS "idx_newsletter_subscribers_subscriber_pubkey" ON "newsletter_subscribers"("subscriber_pubkey");
CREATE INDEX IF NOT EXISTS "idx_newsletter_subscribers_status" ON "newsletter_subscribers"("status");
CREATE INDEX IF NOT EXISTS "idx_newsletter_subscribers_newsletter_id_status" ON "newsletter_subscribers"("newsletter_id", "status");
CREATE INDEX IF NOT EXISTS "idx_newsletter_subscribers_newsletter_id_subscriber_pubkey" ON "newsletter_subscribers"("newsletter_id", "subscriber_pubkey");



-- Wiki module tables
-- Generated from protocol/schemas/modules/wiki/v1.json
-- Version: 1.0.0

-- ── wiki_pages ──

CREATE TABLE IF NOT EXISTS "wiki_pages" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "slug" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "summary" TEXT,
    "version" INTEGER NOT NULL,
    "parent_id" TEXT,
    "category_id" TEXT,
    "status" TEXT NOT NULL CHECK("status" IN ('draft', 'review', 'published', 'archived', 'deleted')),
    "visibility" TEXT CHECK("visibility" IN ('public', 'group', 'private', 'role-restricted')),
    "permissions" TEXT,
    "tags" TEXT,
    "aliases" TEXT,
    "created_by" TEXT NOT NULL,
    "last_edited_by" TEXT,
    "contributors" TEXT,
    "locked_by" TEXT,
    "locked_at" INTEGER,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "published_at" INTEGER,
    "archived_at" INTEGER,
    "deleted_at" INTEGER,
    "metadata" TEXT,
    "indexability" TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_wiki_pages_group_id" ON "wiki_pages"("group_id");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_slug" ON "wiki_pages"("slug");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_title" ON "wiki_pages"("title");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_category_id" ON "wiki_pages"("category_id");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_status" ON "wiki_pages"("status");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_visibility" ON "wiki_pages"("visibility");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_updated_at" ON "wiki_pages"("updated_at");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_created_by" ON "wiki_pages"("created_by");
CREATE INDEX IF NOT EXISTS "idx_wiki_pages_last_edited_by" ON "wiki_pages"("last_edited_by");


-- ── wiki_page_revisions ──

CREATE TABLE IF NOT EXISTS "wiki_page_revisions" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "page_id" TEXT NOT NULL,
    "version" INTEGER NOT NULL,
    "title" TEXT,
    "content" TEXT NOT NULL,
    "summary" TEXT,
    "diff" TEXT,
    "edited_by" TEXT NOT NULL,
    "edit_type" TEXT DEFAULT 'edit' CHECK("edit_type" IN ('create', 'edit', 'revert', 'merge', 'move')),
    "reverted_from" INTEGER,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_wiki_page_revisions_page_id" ON "wiki_page_revisions"("page_id");
CREATE INDEX IF NOT EXISTS "idx_wiki_page_revisions_version" ON "wiki_page_revisions"("version");
CREATE INDEX IF NOT EXISTS "idx_wiki_page_revisions_edited_by" ON "wiki_page_revisions"("edited_by");
CREATE INDEX IF NOT EXISTS "idx_wiki_page_revisions_created_at" ON "wiki_page_revisions"("created_at");


-- ── wiki_categories ──

CREATE TABLE IF NOT EXISTS "wiki_categories" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "slug" TEXT NOT NULL,
    "description" TEXT,
    "parent_id" TEXT,
    "icon" TEXT,
    "color" TEXT,
    "order" INTEGER,
    "page_count" INTEGER,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_wiki_categories_group_id" ON "wiki_categories"("group_id");
CREATE INDEX IF NOT EXISTS "idx_wiki_categories_slug" ON "wiki_categories"("slug");
CREATE INDEX IF NOT EXISTS "idx_wiki_categories_name" ON "wiki_categories"("name");
CREATE INDEX IF NOT EXISTS "idx_wiki_categories_parent_id" ON "wiki_categories"("parent_id");
CREATE INDEX IF NOT EXISTS "idx_wiki_categories_order" ON "wiki_categories"("order");



-- Search module tables
-- Generated from protocol/schemas/modules/search/v1.json
-- Version: 1.0.0

-- ── search_documents ──

CREATE TABLE IF NOT EXISTS "search_documents" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "module_type" TEXT NOT NULL,
    "entity_id" TEXT NOT NULL,
    "group_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "tags" TEXT,
    "excerpt" TEXT,
    "author_pubkey" TEXT,
    "facets" TEXT,
    "vector" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER NOT NULL,
    "indexed_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_search_documents_module_type" ON "search_documents"("module_type");
CREATE INDEX IF NOT EXISTS "idx_search_documents_entity_id" ON "search_documents"("entity_id");
CREATE INDEX IF NOT EXISTS "idx_search_documents_group_id" ON "search_documents"("group_id");
CREATE INDEX IF NOT EXISTS "idx_search_documents_author_pubkey" ON "search_documents"("author_pubkey");
CREATE INDEX IF NOT EXISTS "idx_search_documents_created_at" ON "search_documents"("created_at");
CREATE INDEX IF NOT EXISTS "idx_search_documents_updated_at" ON "search_documents"("updated_at");

CREATE TABLE IF NOT EXISTS "search_documents_tags" (
    "id" TEXT NOT NULL REFERENCES "search_documents"("id") ON DELETE CASCADE,
    "tag" TEXT NOT NULL,
    PRIMARY KEY ("id", "tag")
);

CREATE INDEX IF NOT EXISTS "idx_search_documents_tags_tag" ON "search_documents_tags"("tag");


-- ── tags ──

CREATE TABLE IF NOT EXISTS "tags" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "slug" TEXT NOT NULL,
    "color" TEXT,
    "parent_tag_id" TEXT,
    "usage_count" INTEGER NOT NULL,
    "created_at" INTEGER NOT NULL,
    "created_by" TEXT NOT NULL,
    "updated_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_tags_slug" ON "tags"("slug");
CREATE INDEX IF NOT EXISTS "idx_tags_group_id" ON "tags"("group_id");
CREATE INDEX IF NOT EXISTS "idx_tags_usage_count" ON "tags"("usage_count");


-- ── entity_tags ──

CREATE TABLE IF NOT EXISTS "entity_tags" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "entity_type" TEXT NOT NULL,
    "entity_id" TEXT NOT NULL,
    "tag_id" TEXT NOT NULL,
    "group_id" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "created_by" TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_entity_tags_tag_id" ON "entity_tags"("tag_id");
CREATE INDEX IF NOT EXISTS "idx_entity_tags_entity_id" ON "entity_tags"("entity_id");
CREATE INDEX IF NOT EXISTS "idx_entity_tags_entity_type" ON "entity_tags"("entity_type");
CREATE INDEX IF NOT EXISTS "idx_entity_tags_entity_id_tag_id" ON "entity_tags"("entity_id", "tag_id");


-- ── saved_searches ──

CREATE TABLE IF NOT EXISTS "saved_searches" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "user_pubkey" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "query" TEXT NOT NULL,
    "scope" TEXT NOT NULL,
    "filters" TEXT,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER NOT NULL,
    "last_used_at" INTEGER,
    "use_count" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_saved_searches_group_id" ON "saved_searches"("group_id");
CREATE INDEX IF NOT EXISTS "idx_saved_searches_created_at" ON "saved_searches"("created_at");
CREATE INDEX IF NOT EXISTS "idx_saved_searches_use_count" ON "saved_searches"("use_count");


-- ── recent_searches ──

CREATE TABLE IF NOT EXISTS "recent_searches" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "user_pubkey" TEXT NOT NULL,
    "query" TEXT NOT NULL,
    "scope" TEXT NOT NULL,
    "timestamp" INTEGER NOT NULL,
    "result_count" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_recent_searches_searched_at" ON "recent_searches"("searched_at");



-- Database module tables
-- Generated from protocol/schemas/modules/database/v1.json
-- Version: 1.0.0

-- ── database_tables ──

CREATE TABLE IF NOT EXISTS "database_tables" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "columns" TEXT NOT NULL,
    "group_id" TEXT,
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('private', 'group', 'public')),
    "edit_permission" TEXT DEFAULT 'group' CHECK("edit_permission" IN ('owner', 'editors', 'group')),
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "form_layout" TEXT,
    "detail_config" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_database_tables_group_id" ON "database_tables"("group_id");
CREATE INDEX IF NOT EXISTS "idx_database_tables_name" ON "database_tables"("name");
CREATE INDEX IF NOT EXISTS "idx_database_tables_created_by" ON "database_tables"("created_by");
CREATE INDEX IF NOT EXISTS "idx_database_tables_created_at" ON "database_tables"("created_at");


-- ── database_rows ──

CREATE TABLE IF NOT EXISTS "database_rows" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "table_id" TEXT NOT NULL,
    "data" TEXT NOT NULL,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "updated_by" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_database_rows_table_id" ON "database_rows"("table_id");
CREATE INDEX IF NOT EXISTS "idx_database_rows_group_id" ON "database_rows"("group_id");
CREATE INDEX IF NOT EXISTS "idx_database_rows_created_at" ON "database_rows"("created_at");
CREATE INDEX IF NOT EXISTS "idx_database_rows_created_by" ON "database_rows"("created_by");
CREATE INDEX IF NOT EXISTS "idx_database_rows_updated_at" ON "database_rows"("updated_at");


-- ── database_views ──

CREATE TABLE IF NOT EXISTS "database_views" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "table_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "type" TEXT NOT NULL DEFAULT 'table' CHECK("type" IN ('table', 'grid', 'kanban', 'calendar', 'gallery', 'list')),
    "filters" TEXT,
    "sorts" TEXT,
    "hidden_columns" TEXT,
    "group_by" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_database_views_table_id" ON "database_views"("table_id");
CREATE INDEX IF NOT EXISTS "idx_database_views_group_id" ON "database_views"("group_id");
CREATE INDEX IF NOT EXISTS "idx_database_views_type" ON "database_views"("type");
CREATE INDEX IF NOT EXISTS "idx_database_views_created_at" ON "database_views"("created_at");



-- Calling module tables
-- Generated from protocol/schemas/modules/calling/v1.json
-- Version: 1.0.0

-- ── call_history ──

CREATE TABLE IF NOT EXISTS "call_history" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "call_id" TEXT NOT NULL,
    "remote_pubkey" TEXT NOT NULL,
    "remote_name" TEXT,
    "direction" TEXT NOT NULL CHECK("direction" IN ('outgoing', 'incoming')),
    "call_type" TEXT CHECK("call_type" IN ('voice', 'video', 'group')),
    "started_at" INTEGER NOT NULL,
    "connected_at" INTEGER,
    "ended_at" INTEGER,
    "duration" INTEGER,
    "end_reason" TEXT CHECK("end_reason" IN ('completed', 'rejected', 'busy', 'no_answer', 'network_failure', 'cancelled', 'timeout')),
    "was_encrypted" INTEGER,
    "group_id" TEXT,
    "room_id" TEXT,
    "participant_count" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_call_history_call_id" ON "call_history"("call_id");
CREATE INDEX IF NOT EXISTS "idx_call_history_remote_pubkey" ON "call_history"("remote_pubkey");
CREATE INDEX IF NOT EXISTS "idx_call_history_direction" ON "call_history"("direction");
CREATE INDEX IF NOT EXISTS "idx_call_history_call_type" ON "call_history"("call_type");
CREATE INDEX IF NOT EXISTS "idx_call_history_started_at" ON "call_history"("started_at");
CREATE INDEX IF NOT EXISTS "idx_call_history_group_id" ON "call_history"("group_id");


-- ── call_settings ──

CREATE TABLE IF NOT EXISTS "call_settings" (
    "_v" TEXT DEFAULT '1.0.0',
    "default_call_type" TEXT DEFAULT 'voice' CHECK("default_call_type" IN ('voice', 'video')),
    "auto_answer" INTEGER DEFAULT 0,
    "do_not_disturb" INTEGER DEFAULT 0,
    "allow_unknown_callers" INTEGER DEFAULT 1,
    "relay_only_mode" INTEGER DEFAULT 0,
    "preferred_audio_input" TEXT,
    "preferred_audio_output" TEXT,
    "preferred_video_input" TEXT,
    "echo_cancellation" INTEGER DEFAULT 1,
    "noise_suppression" INTEGER DEFAULT 1,
    "auto_gain_control" INTEGER DEFAULT 1
);

CREATE INDEX IF NOT EXISTS "idx_call_settings_updated_at" ON "call_settings"("updated_at");


-- ── broadcasts ──

CREATE TABLE IF NOT EXISTS "broadcasts" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "broadcast_id" TEXT PRIMARY KEY,
    "title" TEXT,
    "content" TEXT NOT NULL,
    "target_type" TEXT NOT NULL CHECK("target_type" IN ('group', 'contact_list', 'public_channel', 'emergency')),
    "target_ids" TEXT,
    "priority" TEXT DEFAULT 'normal' CHECK("priority" IN ('normal', 'high', 'emergency')),
    "created_by" TEXT NOT NULL,
    "scheduled_at" INTEGER,
    "sent_at" INTEGER,
    "status" TEXT CHECK("status" IN ('draft', 'scheduled', 'sending', 'sent', 'failed')),
    "analytics" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_broadcasts_created_by" ON "broadcasts"("created_by");
CREATE INDEX IF NOT EXISTS "idx_broadcasts_status" ON "broadcasts"("status");
CREATE INDEX IF NOT EXISTS "idx_broadcasts_scheduled_at" ON "broadcasts"("scheduled_at");
CREATE INDEX IF NOT EXISTS "idx_broadcasts_sent_at" ON "broadcasts"("sent_at");


-- ── conference_rooms ──

CREATE TABLE IF NOT EXISTS "conference_rooms" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "room_id" TEXT PRIMARY KEY,
    "group_id" TEXT,
    "name" TEXT NOT NULL,
    "sfu_endpoint" TEXT,
    "max_participants" INTEGER DEFAULT 100,
    "created_by" TEXT NOT NULL,
    "settings" TEXT,
    "created_at" INTEGER,
    "expires_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_conference_rooms_group_id" ON "conference_rooms"("group_id");
CREATE INDEX IF NOT EXISTS "idx_conference_rooms_created_by" ON "conference_rooms"("created_by");
CREATE INDEX IF NOT EXISTS "idx_conference_rooms_created_at" ON "conference_rooms"("created_at");
CREATE INDEX IF NOT EXISTS "idx_conference_rooms_expires_at" ON "conference_rooms"("expires_at");



-- Files module tables
-- Generated from protocol/schemas/modules/files/v1.json
-- Version: 1.0.0

-- ── file_metadata ──

CREATE TABLE IF NOT EXISTS "file_metadata" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "url" TEXT NOT NULL,
    "mime_type" TEXT NOT NULL,
    "size" INTEGER NOT NULL,
    "hash" TEXT,
    "description" TEXT,
    "folder_id" TEXT,
    "group_id" TEXT,
    "visibility" TEXT DEFAULT 'group' CHECK("visibility" IN ('private', 'group', 'public')),
    "encrypted" INTEGER DEFAULT 1,
    "encryption_key_id" TEXT,
    "thumbnail" TEXT,
    "dimensions" TEXT,
    "duration" REAL,
    "uploaded_by" TEXT NOT NULL,
    "uploaded_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_file_metadata_group_id" ON "file_metadata"("group_id");
CREATE INDEX IF NOT EXISTS "idx_file_metadata_folder_id" ON "file_metadata"("folder_id");
CREATE INDEX IF NOT EXISTS "idx_file_metadata_mime_type" ON "file_metadata"("mime_type");
CREATE INDEX IF NOT EXISTS "idx_file_metadata_created_at" ON "file_metadata"("created_at");
CREATE INDEX IF NOT EXISTS "idx_file_metadata_updated_at" ON "file_metadata"("updated_at");
CREATE INDEX IF NOT EXISTS "idx_file_metadata_group_id_updated_at" ON "file_metadata"("group_id", "updated_at");
CREATE INDEX IF NOT EXISTS "idx_file_metadata_group_id_folder_id" ON "file_metadata"("group_id", "folder_id");


-- ── folders ──

CREATE TABLE IF NOT EXISTS "folders" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "parent_id" TEXT,
    "group_id" TEXT,
    "color" TEXT,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_folders_group_id" ON "folders"("group_id");
CREATE INDEX IF NOT EXISTS "idx_folders_parent_id" ON "folders"("parent_id");
CREATE INDEX IF NOT EXISTS "idx_folders_name" ON "folders"("name");
CREATE INDEX IF NOT EXISTS "idx_folders_group_id_parent_id" ON "folders"("group_id", "parent_id");


-- ── file_shares ──

CREATE TABLE IF NOT EXISTS "file_shares" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "file_id" TEXT NOT NULL,
    "shared_with" TEXT NOT NULL,
    "permission" TEXT NOT NULL DEFAULT 'view' CHECK("permission" IN ('view', 'download', 'edit')),
    "expires_at" INTEGER,
    "shared_by" TEXT NOT NULL,
    "shared_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_file_shares_file_id" ON "file_shares"("file_id");
CREATE INDEX IF NOT EXISTS "idx_file_shares_group_id" ON "file_shares"("group_id");
CREATE INDEX IF NOT EXISTS "idx_file_shares_recipient_pubkey" ON "file_shares"("recipient_pubkey");
CREATE INDEX IF NOT EXISTS "idx_file_shares_expires_at" ON "file_shares"("expires_at");



-- Contacts module tables
-- Generated from protocol/schemas/modules/contacts/v1.json
-- Version: 1.0.0

-- ── contacts ──

CREATE TABLE IF NOT EXISTS "contacts" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "pubkey" TEXT PRIMARY KEY,
    "relay" TEXT,
    "petname" TEXT,
    "display_name" TEXT,
    "avatar" TEXT,
    "bio" TEXT,
    "nip05" TEXT,
    "lud16" TEXT,
    "relationship" TEXT NOT NULL CHECK("relationship" IN ('following', 'follower', 'friend', 'blocked')),
    "followed_at" INTEGER,
    "muted_at" INTEGER,
    "blocked_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_contacts_relationship" ON "contacts"("relationship");
CREATE INDEX IF NOT EXISTS "idx_contacts_display_name" ON "contacts"("display_name");


-- ── contact_notes ──

CREATE TABLE IF NOT EXISTS "contact_notes" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "contact_pubkey" TEXT NOT NULL,
    "content" TEXT NOT NULL,
    "category" TEXT NOT NULL CHECK("category" IN ('general', 'meeting', 'follow_up', 'concern', 'positive', 'task')),
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_contact_notes_contact_pubkey" ON "contact_notes"("contact_pubkey");
CREATE INDEX IF NOT EXISTS "idx_contact_notes_category" ON "contact_notes"("category");
CREATE INDEX IF NOT EXISTS "idx_contact_notes_created_at" ON "contact_notes"("created_at");


-- ── contact_tags ──

CREATE TABLE IF NOT EXISTS "contact_tags" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "contact_pubkey" TEXT NOT NULL,
    "tag" TEXT NOT NULL CHECK("tag" IN ('volunteer', 'member', 'leader', 'media_contact', 'ally', 'potential', 'inactive', 'union_rep', 'steward', 'donor'))
);

CREATE INDEX IF NOT EXISTS "idx_contact_tags_contact_pubkey" ON "contact_tags"("contact_pubkey");
CREATE INDEX IF NOT EXISTS "idx_contact_tags_tag" ON "contact_tags"("tag");



-- CustomFields module tables
-- Generated from protocol/schemas/modules/custom-fields/v1.json
-- Version: 1.0.0

-- ── custom_fields ──

CREATE TABLE IF NOT EXISTS "custom_fields" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "name" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "required" INTEGER DEFAULT 0,
    "description" TEXT,
    "default_value" TEXT,
    "options" TEXT,
    "validation" TEXT,
    "order" INTEGER,
    "group_id" TEXT,
    "module_id" TEXT,
    "created_at" INTEGER,
    "updated_at" INTEGER,
    "entity_type" TEXT NOT NULL,
    "created_by" TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_custom_fields_group_id" ON "custom_fields"("group_id");
CREATE INDEX IF NOT EXISTS "idx_custom_fields_entity_type" ON "custom_fields"("entity_type");
CREATE INDEX IF NOT EXISTS "idx_custom_fields_name" ON "custom_fields"("name");
CREATE INDEX IF NOT EXISTS "idx_custom_fields_label" ON "custom_fields"("label");
CREATE INDEX IF NOT EXISTS "idx_custom_fields_created_at" ON "custom_fields"("created_at");
CREATE INDEX IF NOT EXISTS "idx_custom_fields_created_by" ON "custom_fields"("created_by");


-- ── custom_field_values ──

CREATE TABLE IF NOT EXISTS "custom_field_values" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "field_id" TEXT NOT NULL,
    "entity_id" TEXT NOT NULL,
    "entity_type" TEXT NOT NULL,
    "value" TEXT NOT NULL,
    "created_at" INTEGER,
    "updated_at" INTEGER
);

CREATE INDEX IF NOT EXISTS "idx_custom_field_values_field_id" ON "custom_field_values"("field_id");
CREATE INDEX IF NOT EXISTS "idx_custom_field_values_entity_id" ON "custom_field_values"("entity_id");



-- Governance module tables
-- Generated from protocol/schemas/modules/governance/v1.json
-- Version: 1.0.0

-- ── proposals ──

CREATE TABLE IF NOT EXISTS "proposals" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "group_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "type" TEXT NOT NULL CHECK("type" IN ('general', 'policy', 'budget', 'election', 'amendment', 'action', 'resolution')),
    "status" TEXT NOT NULL CHECK("status" IN ('draft', 'discussion', 'voting', 'passed', 'rejected', 'expired', 'withdrawn', 'implemented')),
    "voting_system" TEXT NOT NULL CHECK("voting_system" IN ('simple-majority', 'supermajority', 'ranked-choice', 'approval', 'quadratic', 'd-hondt', 'consensus', 'modified-consensus')),
    "options" TEXT NOT NULL,
    "quorum" TEXT,
    "threshold" TEXT,
    "discussion_period" TEXT,
    "voting_period" TEXT NOT NULL,
    "allow_abstain" INTEGER DEFAULT 1,
    "anonymous_voting" INTEGER DEFAULT 0,
    "allow_delegation" INTEGER DEFAULT 0,
    "created_by" TEXT NOT NULL,
    "created_at" INTEGER NOT NULL,
    "updated_at" INTEGER,
    "attachments" TEXT,
    "tags" TEXT,
    "quadratic_config" TEXT,
    "custom_fields" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_proposals_group_id" ON "proposals"("group_id");
CREATE INDEX IF NOT EXISTS "idx_proposals_type" ON "proposals"("type");
CREATE INDEX IF NOT EXISTS "idx_proposals_status" ON "proposals"("status");
CREATE INDEX IF NOT EXISTS "idx_proposals_voting_system" ON "proposals"("voting_system");
CREATE INDEX IF NOT EXISTS "idx_proposals_created_by" ON "proposals"("created_by");
CREATE INDEX IF NOT EXISTS "idx_proposals_created_at" ON "proposals"("created_at");
CREATE INDEX IF NOT EXISTS "idx_proposals_updated_at" ON "proposals"("updated_at");


-- ── votes ──

CREATE TABLE IF NOT EXISTS "votes" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "proposal_id" TEXT NOT NULL,
    "voter_id" TEXT NOT NULL,
    "choice" TEXT NOT NULL,
    "weight" REAL DEFAULT 1,
    "delegated_from" TEXT,
    "comment" TEXT,
    "cast_at" INTEGER NOT NULL,
    "signature" TEXT
);

CREATE INDEX IF NOT EXISTS "idx_votes_proposal_id" ON "votes"("proposal_id");
CREATE INDEX IF NOT EXISTS "idx_votes_voter_id" ON "votes"("voter_id");
CREATE INDEX IF NOT EXISTS "idx_votes_cast_at" ON "votes"("cast_at");
CREATE INDEX IF NOT EXISTS "idx_votes_proposal_id_voter_id" ON "votes"("proposal_id", "voter_id");


-- ── delegations ──

CREATE TABLE IF NOT EXISTS "delegations" (
    "_v" TEXT NOT NULL DEFAULT '1.0.0',
    "id" TEXT PRIMARY KEY,
    "delegator_id" TEXT NOT NULL,
    "delegate_id" TEXT NOT NULL,
    "scope" TEXT NOT NULL CHECK("scope" IN ('all', 'category', 'proposal')),
    "category_tags" TEXT,
    "proposal_id" TEXT,
    "valid_from" INTEGER,
    "valid_until" INTEGER,
    "revoked" INTEGER DEFAULT 0,
    "created_at" INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS "idx_delegations_delegator_id" ON "delegations"("delegator_id");
CREATE INDEX IF NOT EXISTS "idx_delegations_delegate_id" ON "delegations"("delegate_id");
CREATE INDEX IF NOT EXISTS "idx_delegations_scope" ON "delegations"("scope");
CREATE INDEX IF NOT EXISTS "idx_delegations_created_at" ON "delegations"("created_at");



