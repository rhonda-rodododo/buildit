name: Bundle Size Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.37"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build project
        working-directory: clients/web
        run: bun run build:no-check

      - name: Analyze bundle size
        id: analyze
        run: |
          DIST="clients/web/dist"
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Main Bundle (Initial Load)" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size (Brotli) | Size (Gzip) |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------------|-------------|" >> $GITHUB_STEP_SUMMARY

          # Extract main bundle sizes (skip if compressed files don't exist)
          INDEX_SIZE=$(stat --format=%s $DIST/assets/index-*.js 2>/dev/null || echo "0")
          REACT_SIZE=$(stat --format=%s $DIST/assets/vendor-react-*.js 2>/dev/null || echo "0")

          INDEX_KB=$(( INDEX_SIZE / 1024 ))
          REACT_KB=$(( REACT_SIZE / 1024 ))

          echo "| index.js | ${INDEX_KB}KB |" >> $GITHUB_STEP_SUMMARY
          echo "| vendor-react.js | ${REACT_KB}KB |" >> $GITHUB_STEP_SUMMARY

          # Check bundle size limits
          TOTAL_INITIAL=$((INDEX_SIZE + REACT_SIZE))
          LIMIT=307200  # 300KB limit

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $TOTAL_INITIAL -lt $LIMIT ]; then
            echo "Bundle size check passed! Total initial: $(($TOTAL_INITIAL / 1024))KB (limit: 300KB)" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "Bundle size check failed! Total initial: $(($TOTAL_INITIAL / 1024))KB exceeds limit of 300KB" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-stats
          path: clients/web/dist/
          retention-days: 30

      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
