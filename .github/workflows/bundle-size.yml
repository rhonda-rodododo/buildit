name: Bundle Size Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.37"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Build project
        working-directory: clients/web
        run: bun run build:no-check

      - name: Analyze bundle size
        id: analyze
        run: |
          DIST="clients/web/dist"

          # Sum sizes of all JS files in the dist assets directory
          TOTAL_JS=0
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### JS Bundles" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY

          for f in "$DIST"/assets/*.js; do
            if [ -f "$f" ]; then
              SIZE=$(stat --format=%s "$f")
              KB=$(( SIZE / 1024 ))
              BASENAME=$(basename "$f")
              echo "| $BASENAME | ${KB}KB |" >> $GITHUB_STEP_SUMMARY
              TOTAL_JS=$(( TOTAL_JS + SIZE ))
            fi
          done

          TOTAL_KB=$(( TOTAL_JS / 1024 ))
          LIMIT_KB=2048  # 2MB limit for total JS
          LIMIT=$(( LIMIT_KB * 1024 ))

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total JS: ${TOTAL_KB}KB**" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL_JS" -lt "$LIMIT" ]; then
            echo "Bundle size check passed! Total JS: ${TOTAL_KB}KB (limit: ${LIMIT_KB}KB)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Bundle size check failed! Total JS: ${TOTAL_KB}KB exceeds limit of ${LIMIT_KB}KB" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-stats
          path: clients/web/dist/
          retention-days: 30

      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
