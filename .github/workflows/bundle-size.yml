name: Bundle Size Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  bundle-size:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.37"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Build project
        working-directory: clients/web
        run: bun run build:no-check

      - name: Analyze bundle size
        id: analyze
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const dist = 'clients/web/dist/assets';
            const LIMIT_KB = 2048;

            let total = 0;
            const rows = [];

            if (fs.existsSync(dist)) {
              for (const f of fs.readdirSync(dist).filter(f => f.endsWith('.js')).sort()) {
                const size = fs.statSync(path.join(dist, f)).size;
                total += size;
                rows.push('| ' + f + ' | ' + Math.round(size / 1024) + 'KB |');
              }
            }

            const totalKB = Math.round(total / 1024);
            const summary = process.env.GITHUB_STEP_SUMMARY;

            const report = [
              '## Bundle Size Report', '',
              '### JS Bundles',
              '| File | Size |', '|------|------|',
              ...rows, '',
              '**Total JS: ' + totalKB + 'KB**', '',
              totalKB < LIMIT_KB
                ? 'Bundle size check passed! Total JS: ' + totalKB + 'KB (limit: ' + LIMIT_KB + 'KB)'
                : 'Bundle size check FAILED! Total JS: ' + totalKB + 'KB exceeds limit of ' + LIMIT_KB + 'KB'
            ].join('\n');

            if (summary) fs.appendFileSync(summary, report + '\n');
            console.log(report);

            if (totalKB >= LIMIT_KB) process.exit(1);
          "

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-stats
          path: clients/web/dist/
          retention-days: 30

      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
