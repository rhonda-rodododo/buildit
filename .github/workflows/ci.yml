name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.1.37"
  RUST_TOOLCHAIN: "stable"
  JAVA_VERSION: "17"

jobs:
  # ─────────────────────────────────────────────────────────────
  # Web Client: Tests, Typecheck, Build
  # ─────────────────────────────────────────────────────────────
  web-tests:
    name: Web - Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            clients/web/node_modules
          key: bun-web-${{ runner.os }}-${{ hashFiles('bun.lockb', 'clients/web/package.json') }}
          restore-keys: |
            bun-web-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Run tests
        working-directory: clients/web
        run: bun run test

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-coverage
          path: clients/web/coverage/
          retention-days: 14

  web-typecheck:
    name: Web - Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            clients/web/node_modules
          key: bun-web-${{ runner.os }}-${{ hashFiles('bun.lockb', 'clients/web/package.json') }}
          restore-keys: |
            bun-web-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Typecheck
        working-directory: clients/web
        run: bun run typecheck

  web-build:
    name: Web - Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [web-typecheck]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            clients/web/node_modules
          key: bun-web-${{ runner.os }}-${{ hashFiles('bun.lockb', 'clients/web/package.json') }}
          restore-keys: |
            bun-web-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Build
        working-directory: clients/web
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: clients/web/dist/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────
  # Protocol: Schema Validation & Codegen Drift Detection
  # ─────────────────────────────────────────────────────────────
  protocol-validation:
    name: Protocol - Schema Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-root-${{ runner.os }}-${{ hashFiles('bun.lockb', 'package.json') }}
          restore-keys: |
            bun-root-${{ runner.os }}-

      - name: Install dependencies
        run: bun install

      - name: Validate schemas
        run: bun run codegen:validate

      - name: Run codegen
        run: bun run codegen

      - name: Check for uncommitted codegen drift
        run: |
          if ! git diff --exit-code; then
            echo "::error::Generated code is out of date. Run 'bun run codegen' and commit the result."
            git diff --stat
            exit 1
          fi

      - name: Validate test vectors
        working-directory: tools/codegen
        run: bun run src/index.ts --validate-vectors

  # ─────────────────────────────────────────────────────────────
  # Crypto: Rust Library Tests
  # ─────────────────────────────────────────────────────────────
  crypto-tests:
    name: Crypto - Rust Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/crypto/target
          key: cargo-crypto-${{ runner.os }}-${{ hashFiles('packages/crypto/Cargo.lock', 'packages/crypto/Cargo.toml') }}
          restore-keys: |
            cargo-crypto-${{ runner.os }}-

      - name: Format generated code
        working-directory: packages/crypto
        run: cargo fmt

      - name: Run tests
        working-directory: packages/crypto
        run: cargo test --all-features

      - name: Check formatting
        working-directory: packages/crypto
        run: cargo fmt --check

      - name: Run clippy
        working-directory: packages/crypto
        run: cargo clippy -- -D warnings

  # ─────────────────────────────────────────────────────────────
  # Desktop: Tauri Rust Backend Build Check
  # ─────────────────────────────────────────────────────────────
  desktop-build:
    name: Desktop - Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Bun (for web UI build)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libbluetooth-dev \
            libdbus-1-dev

      - name: Cache cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            clients/desktop/target
          key: cargo-desktop-${{ runner.os }}-${{ hashFiles('clients/desktop/Cargo.lock', 'clients/desktop/Cargo.toml') }}
          restore-keys: |
            cargo-desktop-${{ runner.os }}-

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            clients/web/node_modules
          key: bun-web-${{ runner.os }}-${{ hashFiles('bun.lockb', 'clients/web/package.json') }}
          restore-keys: |
            bun-web-${{ runner.os }}-

      - name: Install web dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Check Rust compilation
        working-directory: clients/desktop
        run: cargo check

  # ─────────────────────────────────────────────────────────────
  # Android: Build Check
  # ─────────────────────────────────────────────────────────────
  android-build:
    name: Android - Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run codegen
        run: bun run codegen

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build debug
        working-directory: clients/android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleDevDebug --no-daemon

  # ─────────────────────────────────────────────────────────────
  # Workers: Typecheck All
  # ─────────────────────────────────────────────────────────────
  workers-typecheck:
    name: Workers - Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-root-${{ runner.os }}-${{ hashFiles('bun.lockb', 'package.json') }}
          restore-keys: |
            bun-root-${{ runner.os }}-

      - name: Install dependencies
        run: bun install

      - name: Run codegen
        run: bun run codegen

      - name: Typecheck API worker
        working-directory: workers/api
        run: bun run typecheck

      - name: Typecheck Relay worker
        working-directory: workers/relay
        run: bun run typecheck

      - name: Typecheck SSR worker
        working-directory: workers/ssr
        run: bun run typecheck

      - name: Typecheck Backend worker
        working-directory: workers/backend
        run: bun run typecheck

  # ─────────────────────────────────────────────────────────────
  # CI Status Gate (for branch protection)
  # ─────────────────────────────────────────────────────────────
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs:
      - web-tests
      - web-typecheck
      - web-build
      - protocol-validation
      - crypto-tests
      - desktop-build
      - android-build
      - workers-typecheck

    steps:
      - name: Check CI results
        run: |
          echo "Web Tests: ${{ needs.web-tests.result }}"
          echo "Web Typecheck: ${{ needs.web-typecheck.result }}"
          echo "Web Build: ${{ needs.web-build.result }}"
          echo "Protocol Validation: ${{ needs.protocol-validation.result }}"
          echo "Crypto Tests: ${{ needs.crypto-tests.result }}"
          echo "Desktop Build: ${{ needs.desktop-build.result }}"
          echo "Android Build: ${{ needs.android-build.result }}"
          echo "Workers Typecheck: ${{ needs.workers-typecheck.result }}"

          # Fail if any required job failed
          if [[ "${{ needs.web-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.web-typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.web-build.result }}" == "failure" ]] || \
             [[ "${{ needs.protocol-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.crypto-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.desktop-build.result }}" == "failure" ]] || \
             [[ "${{ needs.android-build.result }}" == "failure" ]] || \
             [[ "${{ needs.workers-typecheck.result }}" == "failure" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi

          echo "All CI checks passed"
