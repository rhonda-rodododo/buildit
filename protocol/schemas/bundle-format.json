{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://buildit.network/schemas/bundle-format.json",
  "title": "SchemaBundle",
  "description": "Format for offline schema distribution via BLE mesh, QR code, or file transfer",

  "type": "object",
  "required": ["bundleVersion", "createdAt", "minClientVersion", "schemas", "signature", "signedBy"],

  "properties": {
    "bundleVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Version of this bundle"
    },
    "createdAt": {
      "type": "integer",
      "description": "Unix timestamp when bundle was created"
    },
    "minClientVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Minimum client version required to apply this bundle"
    },
    "description": {
      "type": "string",
      "maxLength": 1024,
      "description": "Human-readable description of changes in this bundle"
    },
    "schemas": {
      "type": "object",
      "description": "Module schemas included in this bundle",
      "additionalProperties": {
        "type": "object",
        "required": ["version", "schema"],
        "properties": {
          "version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          },
          "minReaderVersion": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
          },
          "schema": {
            "type": "object",
            "description": "Full JSON Schema for this module"
          }
        }
      }
    },
    "registry": {
      "$ref": "modules/_registry.json",
      "description": "Updated module registry"
    },
    "signature": {
      "type": "string",
      "description": "Ed25519 signature of bundle content (hex)"
    },
    "signedBy": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$",
      "description": "Public key of signer (must be trusted BuildIt key)"
    }
  },

  "examples": [
    {
      "bundleVersion": "1.1.0",
      "createdAt": 1706198400,
      "minClientVersion": "0.1.5",
      "description": "Added events module v1.1 with recurring events support",
      "schemas": {
        "events": {
          "version": "1.1.0",
          "minReaderVersion": "1.0.0",
          "schema": {
            "$id": "https://buildit.network/schemas/modules/events/v1.json",
            "title": "EventsModule",
            "$defs": {}
          }
        }
      },
      "signature": "a1b2c3d4e5f6...",
      "signedBy": "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"
    }
  ],

  "$defs": {
    "BLESyncProtocol": {
      "description": "Protocol for syncing schema bundles over BLE mesh",
      "properties": {
        "discovery": {
          "description": "DeviceInfo advertisement includes schema bundle version",
          "properties": {
            "schemaBundleVersion": {
              "type": "string",
              "description": "Currently installed bundle version"
            },
            "schemaBundleCreatedAt": {
              "type": "integer",
              "description": "Bundle creation timestamp"
            }
          }
        },
        "messageTypes": {
          "REQUEST_BUNDLE": {
            "code": "0x10",
            "description": "Request peer to send their schema bundle"
          },
          "BUNDLE_CHUNK": {
            "code": "0x11",
            "description": "Schema bundle data chunk (uses standard chunking)"
          },
          "BUNDLE_COMPLETE": {
            "code": "0x12",
            "description": "Final chunk indicator"
          }
        }
      }
    },

    "QRCodeFormat": {
      "description": "Format for QR code schema transfer",
      "properties": {
        "singleQR": {
          "description": "For small bundles (<2KB)",
          "format": "buildit://schema/{base64_compressed_bundle}"
        },
        "chunkedQR": {
          "description": "For larger bundles, uses animated QR sequence",
          "format": "buildit://schema-chunk/{chunk_index}/{total_chunks}/{base64_data}"
        }
      }
    },

    "TrustedSigners": {
      "description": "Public keys authorized to sign schema bundles",
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "pubkey": { "type": "string" },
          "validFrom": { "type": "integer" },
          "validUntil": { "type": "integer" }
        }
      },
      "default": [
        {
          "name": "BuildIt Official (2026-02)",
          "pubkey": "44470946c302a9349de9e332ac5496a70ecc7d26bb52b149eea51897b16a771c",
          "validFrom": 1738713600,
          "validUntil": null
        }
      ]
    }
  }
}
