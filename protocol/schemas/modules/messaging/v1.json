{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://buildit.network/schemas/modules/messaging/v1.json",
  "title": "MessagingModule",
  "description": "Schema for BuildIt core messaging - MUST remain backward compatible indefinitely",

  "version": "1.0.0",
  "minReaderVersion": "1.0.0",
  "deprecatedAt": null,
  "sunsetAt": null,
  "coreModule": true,

  "type": "object",

  "compatibilityNotes": [
    "This is a CORE module - changes must maintain indefinite backward compatibility",
    "New optional fields may be added (patch version)",
    "Required fields may NEVER be added or changed (breaking change forbidden)",
    "Field types may NEVER change",
    "This ensures crisis-scenario interoperability across all client versions"
  ],

  "$defs": {
    "DirectMessage": {
      "type": "object",
      "description": "Direct message content (sent via NIP-17 gift wrap)",
      "required": ["content", "_v"],
      "additionalProperties": true,
      "properties": {
        "_v": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Schema version"
        },
        "content": {
          "type": "string",
          "maxLength": 65535,
          "description": "Message text content"
        },
        "replyTo": {
          "type": "string",
          "description": "ID of message being replied to"
        },
        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/Attachment" },
          "maxItems": 10
        },
        "mentions": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[0-9a-f]{64}$"
          },
          "description": "Pubkeys of mentioned users"
        },
        "linkPreviews": {
          "type": "array",
          "items": { "$ref": "https://buildit.network/schemas/modules/content/v1.json#/$defs/LinkPreview" },
          "maxItems": 10,
          "description": "Signal-style encrypted link previews"
        }
      }
    },

    "GroupMessage": {
      "type": "object",
      "description": "Group message content",
      "required": ["content", "groupId", "_v"],
      "additionalProperties": true,
      "properties": {
        "_v": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "content": {
          "type": "string",
          "maxLength": 65535
        },
        "groupId": {
          "type": "string",
          "description": "Target group identifier"
        },
        "threadId": {
          "type": "string",
          "description": "Thread within group (optional)"
        },
        "replyTo": {
          "type": "string"
        },
        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/Attachment" },
          "maxItems": 10
        },
        "mentions": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[0-9a-f]{64}$"
          }
        },
        "linkPreviews": {
          "type": "array",
          "items": { "$ref": "https://buildit.network/schemas/modules/content/v1.json#/$defs/LinkPreview" },
          "maxItems": 10,
          "description": "Signal-style encrypted link previews"
        }
      }
    },

    "Attachment": {
      "type": "object",
      "description": "Media attachment",
      "required": ["type", "url"],
      "additionalProperties": true,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["image", "file", "audio", "video"]
        },
        "url": {
          "type": "string",
          "maxLength": 2048,
          "description": "Content URL or data URL"
        },
        "mimeType": {
          "type": "string"
        },
        "size": {
          "type": "integer",
          "description": "Size in bytes"
        },
        "name": {
          "type": "string",
          "maxLength": 256,
          "description": "Filename"
        },
        "dimensions": {
          "type": "object",
          "properties": {
            "width": { "type": "integer" },
            "height": { "type": "integer" }
          }
        },
        "duration": {
          "type": "number",
          "description": "Duration in seconds (audio/video)"
        },
        "blurhash": {
          "type": "string",
          "description": "BlurHash placeholder for images"
        },
        "thumbnail": {
          "type": "string",
          "description": "Thumbnail URL for video"
        }
      }
    },

    "Reaction": {
      "type": "object",
      "description": "Reaction to a message",
      "required": ["emoji", "targetId", "_v"],
      "additionalProperties": true,
      "properties": {
        "_v": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "emoji": {
          "type": "string",
          "maxLength": 32,
          "description": "Emoji character or shortcode"
        },
        "targetId": {
          "type": "string",
          "description": "ID of message being reacted to"
        }
      }
    },

    "ReadReceipt": {
      "type": "object",
      "description": "Read receipt for messages",
      "required": ["lastRead", "conversationId", "_v"],
      "additionalProperties": true,
      "properties": {
        "_v": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "lastRead": {
          "type": "string",
          "description": "ID of last read message"
        },
        "conversationId": {
          "type": "string",
          "description": "DM partner pubkey or group ID"
        },
        "readAt": {
          "type": "integer",
          "description": "Unix timestamp"
        }
      }
    },

    "TypingIndicator": {
      "type": "object",
      "description": "Ephemeral typing indicator",
      "required": ["typing", "conversationId", "_v"],
      "additionalProperties": true,
      "properties": {
        "_v": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "typing": {
          "type": "boolean"
        },
        "conversationId": {
          "type": "string"
        }
      }
    }
  },

  "testVectors": [
    {
      "name": "minimal_dm",
      "description": "Direct message with only content",
      "valid": true,
      "input": {
        "_v": "1.0.0",
        "content": "Hello!"
      }
    },
    {
      "name": "dm_with_attachment",
      "description": "Direct message with image attachment",
      "valid": true,
      "input": {
        "_v": "1.0.0",
        "content": "Check this out",
        "attachments": [
          {
            "type": "image",
            "url": "data:image/png;base64,iVBORw0KGgo...",
            "mimeType": "image/png",
            "size": 12345,
            "dimensions": { "width": 800, "height": 600 },
            "blurhash": "LEHV6nWB2yk8pyo0adR*.7kCMdnj"
          }
        ]
      }
    },
    {
      "name": "group_message_with_reply",
      "description": "Group message replying to another",
      "valid": true,
      "input": {
        "_v": "1.0.0",
        "content": "Great point!",
        "groupId": "group-123",
        "replyTo": "msg-456",
        "mentions": ["0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"]
      }
    }
  ],

  "x-storage": {
    "tables": {},
    "dbOnly": {},
    "protocolOnly": []
  }
}
