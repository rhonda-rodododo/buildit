{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://buildit.network/schemas/modules/federation/v1.json",
  "title": "FederationModuleSchema",
  "description": "Configuration and status types for ActivityPub and AT Protocol federation",
  "version": "1.0.0",
  "minReaderVersion": "1.0.0",
  "coreModule": false,

  "$defs": {
    "FederationConfig": {
      "type": "object",
      "description": "Per-identity federation configuration",
      "required": ["_v", "nostrPubkey", "apEnabled", "atEnabled"],
      "properties": {
        "_v": {
          "type": "string",
          "description": "Schema version for graceful degradation",
          "default": "1.0.0"
        },
        "nostrPubkey": {
          "type": "string",
          "description": "Hex-encoded Nostr public key",
          "pattern": "^[0-9a-f]{64}$"
        },
        "username": {
          "type": "string",
          "description": "Federation username (e.g., user@buildit.network)",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "minLength": 1,
          "maxLength": 64
        },
        "apEnabled": {
          "type": "boolean",
          "description": "Whether ActivityPub federation is enabled",
          "default": false
        },
        "atEnabled": {
          "type": "boolean",
          "description": "Whether AT Protocol (Bluesky) federation is enabled",
          "default": false
        },
        "atHandle": {
          "type": ["string", "null"],
          "description": "Bluesky handle (e.g., user.bsky.social)"
        }
      },
      "additionalProperties": false
    },
    "FederationStatus": {
      "type": "object",
      "description": "Federation status for a specific post/event",
      "required": ["_v", "nostrEventId"],
      "properties": {
        "_v": {
          "type": "string",
          "description": "Schema version for graceful degradation",
          "default": "1.0.0"
        },
        "nostrEventId": {
          "type": "string",
          "description": "The Nostr event ID this status refers to"
        },
        "apFederated": {
          "type": "boolean",
          "description": "Whether this event has been federated via ActivityPub",
          "default": false
        },
        "apActivityId": {
          "type": ["string", "null"],
          "description": "The AP activity ID if federated"
        },
        "atFederated": {
          "type": "boolean",
          "description": "Whether this event has been cross-posted to AT Protocol",
          "default": false
        },
        "atUri": {
          "type": ["string", "null"],
          "description": "The AT Protocol URI if cross-posted"
        },
        "federatedAt": {
          "type": ["string", "null"],
          "description": "ISO 8601 timestamp of when the event was federated",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "FederationInteraction": {
      "type": "object",
      "description": "An incoming interaction from a federated platform",
      "required": ["_v", "sourceProtocol", "sourceActorId", "interactionType"],
      "properties": {
        "_v": {
          "type": "string",
          "description": "Schema version for graceful degradation",
          "default": "1.0.0"
        },
        "id": {
          "type": "integer",
          "description": "Unique interaction ID"
        },
        "targetNostrEventId": {
          "type": ["string", "null"],
          "description": "The Nostr event this interaction targets"
        },
        "sourceProtocol": {
          "type": "string",
          "enum": ["activitypub", "atproto"],
          "description": "Which federated protocol this came from"
        },
        "sourceActorId": {
          "type": "string",
          "description": "The remote actor's identifier (AP actor URI or AT DID)"
        },
        "sourceActorName": {
          "type": ["string", "null"],
          "description": "Human-readable name of the remote actor"
        },
        "interactionType": {
          "type": "string",
          "enum": ["reply", "like", "repost"],
          "description": "Type of interaction"
        },
        "content": {
          "type": ["string", "null"],
          "description": "Content of the interaction (e.g., reply text)"
        },
        "sourceUrl": {
          "type": ["string", "null"],
          "description": "URL to the interaction on its home platform"
        },
        "receivedAt": {
          "type": "string",
          "description": "When BuildIt received this interaction",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },

    "FederationIdentity": {
      "type": "object",
      "description": "Maps a Nostr pubkey to ActivityPub and AT Protocol accounts",
      "required": ["_v", "nostrPubkey", "username", "apEnabled", "atEnabled", "createdAt", "updatedAt"],
      "properties": {
        "_v": {
          "type": "string",
          "default": "1.0.0"
        },
        "nostrPubkey": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "username": {
          "type": "string"
        },
        "apEnabled": {
          "type": "boolean"
        },
        "apActorId": {
          "type": ["string", "null"]
        },
        "apPrivateKey": {
          "type": ["string", "null"],
          "description": "Encrypted AP private key"
        },
        "atEnabled": {
          "type": "boolean"
        },
        "atDid": {
          "type": ["string", "null"]
        },
        "atHandle": {
          "type": ["string", "null"]
        },
        "atSessionEncrypted": {
          "type": ["string", "null"]
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },

    "APFollower": {
      "type": "object",
      "description": "ActivityPub follower relationship record",
      "required": ["_v", "localActor", "remoteActorId", "remoteInbox", "acceptedAt"],
      "properties": {
        "_v": {
          "type": "string",
          "default": "1.0.0"
        },
        "id": {
          "type": "integer"
        },
        "localActor": {
          "type": "string",
          "description": "Local actor username"
        },
        "remoteActorId": {
          "type": "string",
          "description": "Remote AP actor URI"
        },
        "remoteInbox": {
          "type": "string",
          "description": "Remote actor's inbox URL"
        },
        "remoteSharedInbox": {
          "type": ["string", "null"],
          "description": "Remote actor's shared inbox URL"
        },
        "acceptedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },

    "FederatedPost": {
      "type": "object",
      "description": "Tracks a post federated across Nostr, AP, and AT Protocol",
      "required": ["_v", "nostrEventId", "nostrPubkey", "federatedAt"],
      "properties": {
        "_v": {
          "type": "string",
          "default": "1.0.0"
        },
        "nostrEventId": {
          "type": "string"
        },
        "nostrPubkey": {
          "type": "string"
        },
        "apActivityId": {
          "type": ["string", "null"]
        },
        "atUri": {
          "type": ["string", "null"]
        },
        "atCid": {
          "type": ["string", "null"]
        },
        "federatedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    }
  }
}
